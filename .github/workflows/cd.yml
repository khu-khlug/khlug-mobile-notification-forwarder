name: CD

on:
  push:
    branches:
      - release

jobs:
  build-and-release:
    name: Build, Release, and Back-merge
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      # ==================== SETUP PHASE ====================

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "쿠러그 도우미"
          git config user.email "we_are@khlug.org"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ==================== VERSION INCREMENT PHASE ====================

      - name: Read current versionCode
        id: read_version
        run: |
          CURRENT_VERSION=$(grep -E '^\s*versionCode\s*=\s*[0-9]+' app/build.gradle.kts | sed -E 's/.*versionCode\s*=\s*([0-9]+).*/\1/')
          echo "Current versionCode: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Increment versionCode
        id: increment_version
        run: |
          CURRENT_VERSION=${{ steps.read_version.outputs.current_version }}
          NEW_VERSION=$((CURRENT_VERSION + 1))
          echo "New versionCode: $NEW_VERSION"

          sed -i -E "s/(versionCode\s*=\s*)([0-9]+)/\1$NEW_VERSION/" app/build.gradle.kts

          grep "versionCode" app/build.gradle.kts

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit version bump
        id: commit_version
        run: |
          git add app/build.gradle.kts
          git commit -m "chore: bump versionCode to ${{ steps.increment_version.outputs.new_version }} [skip ci]"
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Push version bump to release
        run: git push origin release

      # ==================== KEYSTORE SETUP PHASE ====================

      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > app/release-keystore.jks

      # ==================== BUILD PHASE ====================

      - name: Build signed release APK
        run: ./gradlew assembleRelease --stacktrace
        env:
          KEYSTORE_FILE: release-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Find APK file
        id: find_apk
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" -type f | head -n 1)
          APK_NAME=$(basename "$APK_PATH")
          echo "APK found at: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT

      # ==================== RELEASE PHASE ====================

      - name: Read versionName
        id: read_version_name
        run: |
          VERSION_NAME=$(grep -E '^\s*versionName\s*=\s*"[^"]+"' app/build.gradle.kts | sed -E 's/.*versionName\s*=\s*"([^"]+)".*/\1/')
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.read_version_name.outputs.version_name }}-build.${{ steps.increment_version.outputs.new_version }}
          name: Release v${{ steps.read_version_name.outputs.version_name }} (Build ${{ steps.increment_version.outputs.new_version }})
          body: |
            ## Release v${{ steps.read_version_name.outputs.version_name }}

            **Build:** ${{ steps.increment_version.outputs.new_version }}
            **Commit:** ${{ steps.commit_version.outputs.commit_sha }}
          files: ${{ steps.find_apk.outputs.apk_path }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== BACK-MERGE PHASE ====================

      - name: Back-merge version bump to main
        run: |
          git fetch origin main
          git checkout main
          git merge origin/release --no-ff -m "chore: back-merge version bump from release (versionCode ${{ steps.increment_version.outputs.new_version }})"
          git push origin main

      # ==================== DISCORD NOTIFICATION PHASE ====================

      - name: Send Discord notification on success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: "success"
          title: "Release v${{ steps.read_version_name.outputs.version_name }} (Build ${{ steps.increment_version.outputs.new_version }}) Published"
          description: |
            **APK:** ${{ steps.find_apk.outputs.apk_name }}
            **Download:** ${{ steps.create_release.outputs.url }}
            **Commit:** ${{ steps.commit_version.outputs.commit_sha }}
            **Back-merged to main**
          color: 0x00ff00
          username: GitHub Actions

      - name: Send Discord notification on failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: "failure"
          title: "CD Failed"
          description: |
            **Branch:** release
            **Commit:** ${{ github.sha }}
            **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0xff0000
          username: GitHub Actions

      # ==================== CLEANUP PHASE ====================

      - name: Cleanup keystore
        if: always()
        run: rm -f app/release-keystore.jks
